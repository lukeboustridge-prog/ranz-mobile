---
phase: 13-offline-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/sync-service.ts
autonomous: true

must_haves:
  truths:
    - "Photo upload triggers SYNCED custody event after successful upload"
    - "Video upload triggers SYNCED custody event after successful upload"
    - "Voice note upload triggers SYNCED custody event after successful upload"
    - "Custody events include hash verification at sync time"
  artifacts:
    - path: "src/services/sync-service.ts"
      provides: "Sync service with chain of custody logging"
      contains: "logSync"
  key_links:
    - from: "src/services/sync-service.ts"
      to: "src/services/chain-of-custody.ts"
      via: "import and logSync call"
      pattern: "import.*logSync.*chain-of-custody"
    - from: "uploadPhotoToPresignedUrl"
      to: "logSync"
      via: "call after successful upload"
      pattern: "logSync\\(.*photo.*photoId"
---

<objective>
Wire chain-of-custody SYNCED events into the sync service for evidence audit trail.

Purpose: Every piece of evidence (photo, video, voice note) must have a complete chain of custody for legal admissibility. The SYNCED event records when evidence was uploaded to the server, including the hash at that moment for verification.

Output: sync-service.ts calls logSync from chain-of-custody.ts after every successful evidence upload.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-offline-sync/13-RESEARCH.md

@src/services/sync-service.ts
@src/services/chain-of-custody.ts
@src/lib/sqlite.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chain-of-custody import and user context to sync-service</name>
  <files>src/services/sync-service.ts</files>
  <action>
Add chain-of-custody import and get user context for custody logging:

1. Add import at the top of the file (around line 15, with other imports):
   ```typescript
   import { logSync as logCustodySync } from "./chain-of-custody";
   ```
   Note: Rename to `logCustodySync` to avoid conflict with existing console logging.

2. Add import for getUser from sqlite (if not already present):
   ```typescript
   import {
     // ... existing imports ...
     getUser, // ADD if not present
   } from "../lib/sqlite";
   ```

3. Add a helper method to SyncEngine class (after the constructor, around line 130):
   ```typescript
   /**
    * Get current user info for custody logging
    * Returns userId and userName for audit trail
    */
   private async getCurrentUser(): Promise<{ userId: string; userName: string }> {
     try {
       const user = await getUser();
       if (user) {
         return { userId: user.id, userName: user.name };
       }
     } catch (error) {
       console.warn('[Sync] Could not get user for custody logging:', error);
     }
     // Fallback for when user not available
     return { userId: 'system', userName: 'System Sync' };
   }
   ```

This sets up the foundation for custody logging. The actual logSync calls will be added in Task 2.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/services/sync-service.ts
```
Verify logCustodySync is imported from chain-of-custody.
  </verify>
  <done>
sync-service.ts imports logSync as logCustodySync from chain-of-custody.ts. getCurrentUser helper method exists in SyncEngine class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SYNCED custody events to photo, video, and voice note uploads</name>
  <files>src/services/sync-service.ts</files>
  <action>
Add logCustodySync calls after each successful evidence upload:

1. In uploadPhotoToPresignedUrl method (around line 850), after the successful upload block:
   ```typescript
   if (uploadResult.status >= 200 && uploadResult.status < 300) {
     // Extract the public URL (remove query params from presigned URL)
     const publicUrl = uploadUrl.split("?")[0];
     await updatePhotoSyncStatus(photoId, "synced", publicUrl);
     console.log(`[Sync] Photo ${photoId} uploaded successfully`);

     // Log chain of custody SYNCED event
     try {
       const { userId, userName } = await this.getCurrentUser();
       await logCustodySync(
         "photo",
         photoId,
         userId,
         userName,
         photo.originalHash, // Hash from when photo was captured
         publicUrl
       );
       console.log(`[Sync] Logged SYNCED custody event for photo ${photoId}`);
     } catch (custodyError) {
       // Don't fail the upload if custody logging fails, just warn
       console.warn(`[Sync] Failed to log custody event for photo ${photoId}:`, custodyError);
     }

     return true;
   }
   ```

2. In uploadVideo method (around line 910), after successful TUS upload:
   ```typescript
   if (result.success && result.url) {
     await updateVideoSyncStatus(video.id, "synced", result.url);

     // Log chain of custody SYNCED event
     try {
       const { userId, userName } = await this.getCurrentUser();
       await logCustodySync(
         "video",
         video.id,
         userId,
         userName,
         video.originalHash || '', // May be null for legacy videos
         result.url
       );
       console.log(`[Sync] Logged SYNCED custody event for video ${video.id}`);
     } catch (custodyError) {
       console.warn(`[Sync] Failed to log custody event for video ${video.id}:`, custodyError);
     }

     return true;
   }
   ```

3. Also in uploadVideo method, after successful direct upload (around line 945):
   ```typescript
   if (uploadResult.status >= 200 && uploadResult.status < 300) {
     await updateVideoSyncStatus(video.id, "synced", presignedResponse.data.publicUrl);

     // Log chain of custody SYNCED event
     try {
       const { userId, userName } = await this.getCurrentUser();
       await logCustodySync(
         "video",
         video.id,
         userId,
         userName,
         video.originalHash || '',
         presignedResponse.data.publicUrl
       );
       console.log(`[Sync] Logged SYNCED custody event for video ${video.id}`);
     } catch (custodyError) {
       console.warn(`[Sync] Failed to log custody event for video ${video.id}:`, custodyError);
     }

     return true;
   }
   ```

4. In uploadVoiceNote method (around line 1005), after successful upload:
   ```typescript
   if (uploadResult.status >= 200 && uploadResult.status < 300) {
     await updateVoiceNoteSyncStatus(voiceNote.id, "synced", presignedResponse.data.publicUrl);
     console.log(`[Sync] Voice note ${voiceNote.id} uploaded successfully`);

     // Log chain of custody SYNCED event
     try {
       const { userId, userName } = await this.getCurrentUser();
       await logCustodySync(
         "voice_note",
         voiceNote.id,
         userId,
         userName,
         voiceNote.originalHash || '',
         presignedResponse.data.publicUrl
       );
       console.log(`[Sync] Logged SYNCED custody event for voice note ${voiceNote.id}`);
     } catch (custodyError) {
       console.warn(`[Sync] Failed to log custody event for voice note ${voiceNote.id}:`, custodyError);
     }

     return true;
   }
   ```

IMPORTANT: Wrap all custody logging in try/catch - custody logging should never fail the sync operation itself.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit src/services/sync-service.ts
```
Search for logCustodySync calls:
```bash
grep -n "logCustodySync" src/services/sync-service.ts
```
Should find at least 4 occurrences (1 import + 3-4 calls).
  </verify>
  <done>
sync-service.ts calls logCustodySync for photos, videos, and voice notes after successful uploads. Each call includes entity type, entity ID, user info, original hash, and server URL. Custody errors are caught and logged but don't fail the sync.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds
2. logCustodySync imported from chain-of-custody.ts
3. getCurrentUser method exists in SyncEngine class
4. Photo upload success path calls logCustodySync with "photo" entity type
5. Video upload success paths (both TUS and direct) call logCustodySync with "video"
6. Voice note upload success path calls logCustodySync with "voice_note"
7. All custody calls wrapped in try/catch to prevent sync failures
</verification>

<success_criteria>
- Every successful evidence upload triggers a SYNCED custody event
- Custody events include hash at sync time for verification
- Custody logging failures don't prevent sync completion
- Audit trail is complete for legal admissibility
</success_criteria>

<output>
After completion, create `.planning/phases/13-offline-sync/13-02-SUMMARY.md`
</output>
