---
phase: 13-offline-sync
plan: 05
type: execute
wave: 4
depends_on: ["13-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "App captures photos and saves locally while in airplane mode"
    - "Photos sync to server when connectivity is restored"
    - "Chain of custody shows SYNCED event with correct hash"
    - "Failed uploads can be retried from sync status UI"
    - "Conflict modal appears when concurrent edits detected"
---

<objective>
Verify offline sync functionality with human testing of the complete flow.

Purpose: Validate that the offline-first sync system works end-to-end: capture while offline, automatic sync on connectivity restore, proper chain of custody logging, and UI for handling failures and conflicts.

Output: Human verification that all Phase 13 features work correctly in real usage scenarios.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-offline-sync/13-RESEARCH.md
@.planning/phases/13-offline-sync/13-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete offline sync system with:
- Background sync using expo-background-task API
- Idempotency keys preventing duplicate uploads
- Retry queue with max 5 attempts and exponential backoff
- Chain of custody SYNCED events for all evidence
- Post-sync hash verification
- Conflict resolution UI modal
- Sync status bar with retry functionality
  </what-built>
  <how-to-verify>
**Test 1: Offline Capture and Sync**
1. Put device in airplane mode
2. Open the app and create a new report
3. Capture 3-5 photos with GPS enabled
4. Verify photos appear in gallery with "pending sync" indicator
5. Turn off airplane mode
6. Observe automatic sync starting within 30 seconds
7. Verify all photos show "synced" status after sync completes

**Test 2: Sync Status Bar**
1. Open the app with airplane mode OFF
2. Look for sync status bar (should show "Online" with green dot)
3. Turn on airplane mode
4. Observe status bar showing "Offline" with red dot
5. Capture a photo while offline
6. Turn off airplane mode
7. Tap "Sync Now" button if visible
8. Verify pending count decreases as items sync

**Test 3: Failed Retry**
1. Force a sync failure (e.g., by disconnecting mid-upload or using a report with invalid data)
2. Observe failed count in sync status bar
3. Tap the failed count to trigger retry
4. Verify retry attempt starts

**Test 4: Chain of Custody Verification**
1. Sync a photo successfully
2. Check the audit log (in dev tools or database viewer)
3. Verify SYNCED event exists with:
   - Correct entityType: "photo"
   - Correct entityId matching the photo
   - Hash value in details
   - Server URL in details
4. Verify VERIFIED event exists (if hash verification ran)

**Test 5: Background Sync (if time permits)**
1. Capture photos while online
2. Close the app completely (swipe away)
3. Wait 15+ minutes
4. Re-open app
5. Check if photos synced while app was closed
   (Note: Background sync is opportunistic - may not always run)

**Expected Results:**
- Photos captured offline sync automatically when connectivity returns
- Sync status bar accurately reflects online/offline state and pending counts
- Failed items can be retried from the UI
- Chain of custody log contains SYNCED events with hashes
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass.
Type "issues: [describe problems]" if any tests fail.
  </resume-signal>
</task>

</tasks>

<verification>
Human verifies:
1. Offline capture works with no network
2. Automatic sync triggers when connectivity restored
3. Sync status bar shows accurate state
4. Failed items are retryable
5. Chain of custody events are logged correctly
</verification>

<success_criteria>
- All 4 required tests pass
- Background sync test runs (result may vary based on OS background policies)
- User confirms offline-first experience works smoothly
</success_criteria>

<output>
After completion, create `.planning/phases/13-offline-sync/13-05-SUMMARY.md`
</output>
