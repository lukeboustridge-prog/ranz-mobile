---
phase: 14-report-integration
plan: 04
type: execute
wave: 3
depends_on: ["14-01", "14-02", "14-03"]
files_modified:
  - ../RANZ_Roofing_report/src/components/client/PhotoGallery.tsx
  - ../RANZ_Roofing_report/src/components/reports/sync-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Report builder shows sync status indicator for each photo"
    - "Photos pending upload show placeholder with 'Syncing' state"
    - "Photos with empty URL show 'Pending' state"
    - "Hash verification status visible in photo details"
  artifacts:
    - path: "../RANZ_Roofing_report/src/components/reports/sync-status-badge.tsx"
      provides: "Reusable sync status badge component"
      exports: ["SyncStatusBadge"]
    - path: "../RANZ_Roofing_report/src/components/client/PhotoGallery.tsx"
      provides: "Updated photo gallery with sync status"
      contains: "SyncStatusBadge"
  key_links:
    - from: "../RANZ_Roofing_report/src/components/client/PhotoGallery.tsx"
      to: "SyncStatusBadge"
      via: "component render"
      pattern: "<SyncStatusBadge"
---

<objective>
Add sync status indicators to the web report builder photo gallery.

Purpose: Inspectors and admins need to see which photos have synced from mobile, which are pending, and whether evidence integrity is verified. This provides real-time visibility into the sync process.

Output: SyncStatusBadge component and updated photo gallery with sync status display.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-report-integration/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncStatusBadge component</name>
  <files>../RANZ_Roofing_report/src/components/reports/sync-status-badge.tsx</files>
  <action>
Create a reusable sync status badge component for photos in the report builder:

1. Create file at `RANZ_Roofing_report/src/components/reports/sync-status-badge.tsx`:

```tsx
"use client";

import { cn } from "@/lib/utils";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import {
  CheckCircle2,
  Clock,
  AlertCircle,
  CloudOff,
  Shield,
  ShieldAlert,
  Loader2,
} from "lucide-react";

export type SyncStatus =
  | "synced"
  | "pending"
  | "syncing"
  | "error"
  | "offline";

export interface SyncStatusBadgeProps {
  status: SyncStatus;
  hashVerified?: boolean;
  className?: string;
  showLabel?: boolean;
  size?: "sm" | "md" | "lg";
}

const statusConfig: Record<
  SyncStatus,
  {
    icon: typeof CheckCircle2;
    label: string;
    color: string;
    bgColor: string;
    description: string;
  }
> = {
  synced: {
    icon: CheckCircle2,
    label: "Synced",
    color: "text-green-600",
    bgColor: "bg-green-100",
    description: "Photo uploaded and available",
  },
  pending: {
    icon: Clock,
    label: "Pending",
    color: "text-amber-600",
    bgColor: "bg-amber-100",
    description: "Waiting for upload from mobile",
  },
  syncing: {
    icon: Loader2,
    label: "Syncing",
    color: "text-blue-600",
    bgColor: "bg-blue-100",
    description: "Upload in progress",
  },
  error: {
    icon: AlertCircle,
    label: "Error",
    color: "text-red-600",
    bgColor: "bg-red-100",
    description: "Upload failed - will retry",
  },
  offline: {
    icon: CloudOff,
    label: "Offline",
    color: "text-gray-600",
    bgColor: "bg-gray-100",
    description: "Captured offline - will sync when online",
  },
};

const sizeClasses = {
  sm: "h-4 w-4",
  md: "h-5 w-5",
  lg: "h-6 w-6",
};

export function SyncStatusBadge({
  status,
  hashVerified,
  className,
  showLabel = false,
  size = "md",
}: SyncStatusBadgeProps) {
  const config = statusConfig[status];
  const Icon = config.icon;
  const isAnimated = status === "syncing";

  return (
    <TooltipProvider>
      <Tooltip>
        <TooltipTrigger asChild>
          <div
            className={cn(
              "inline-flex items-center gap-1.5 rounded-full px-2 py-0.5",
              config.bgColor,
              className
            )}
          >
            <Icon
              className={cn(
                sizeClasses[size],
                config.color,
                isAnimated && "animate-spin"
              )}
            />
            {showLabel && (
              <span className={cn("text-xs font-medium", config.color)}>
                {config.label}
              </span>
            )}
            {status === "synced" && hashVerified !== undefined && (
              <HashVerificationIcon
                verified={hashVerified}
                size={size}
              />
            )}
          </div>
        </TooltipTrigger>
        <TooltipContent side="top" className="max-w-xs">
          <div className="text-sm">
            <p className="font-medium">{config.label}</p>
            <p className="text-muted-foreground">{config.description}</p>
            {status === "synced" && hashVerified !== undefined && (
              <p className="mt-1 text-xs">
                {hashVerified ? (
                  <span className="text-green-600">
                    Evidence integrity verified
                  </span>
                ) : (
                  <span className="text-amber-600">
                    Hash verification pending
                  </span>
                )}
              </p>
            )}
          </div>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

function HashVerificationIcon({
  verified,
  size,
}: {
  verified: boolean;
  size: "sm" | "md" | "lg";
}) {
  const Icon = verified ? Shield : ShieldAlert;
  const color = verified ? "text-green-600" : "text-amber-600";

  return (
    <Icon className={cn(sizeClasses[size], color)} />
  );
}

/**
 * Derive sync status from photo data
 * Use this to determine status from photo record
 */
export function deriveSyncStatus(photo: {
  url?: string | null;
  uploadedAt?: Date | string | null;
}): SyncStatus {
  if (!photo.url || photo.url === "") {
    return "pending";
  }
  if (photo.uploadedAt) {
    return "synced";
  }
  return "syncing";
}
```

2. This component provides:
   - Visual status indicator with icon + optional label
   - Tooltip with detailed description
   - Hash verification badge for synced photos
   - Helper function to derive status from photo data
  </action>
  <verify>
```bash
cd ../RANZ_Roofing_report && npx tsc --noEmit src/components/reports/sync-status-badge.tsx
```
Check that SyncStatusBadge and deriveSyncStatus are exported.
  </verify>
  <done>
SyncStatusBadge component created with status indicator, hash verification badge, tooltip, and deriveSyncStatus helper. Component uses Tailwind CSS classes and Lucide icons consistent with the design system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update photo gallery with sync status</name>
  <files>../RANZ_Roofing_report/src/components/client/PhotoGallery.tsx</files>
  <action>
Update the existing PhotoGallery component to show sync status:

1. First, read the existing PhotoGallery.tsx at `src/components/client/PhotoGallery.tsx` to understand current structure.

2. Extend the Photo interface to include sync-related fields:
```tsx
export interface Photo {
  id: string;
  url: string;
  thumbnailUrl?: string | null;
  caption?: string | null;
  photoType?: string;
  hashVerified?: boolean;
  uploadedAt?: Date | string | null;
}
```

3. Add import for SyncStatusBadge (adjust relative path as needed):
```tsx
import { SyncStatusBadge, deriveSyncStatus } from "../reports/sync-status-badge";
```

3. In the photo card/thumbnail component, add the sync status badge. Find where photo thumbnails are rendered and add:

```tsx
{/* Add in the photo card, typically in top-right corner */}
<div className="absolute top-2 right-2">
  <SyncStatusBadge
    status={deriveSyncStatus(photo)}
    hashVerified={photo.hashVerified}
    size="sm"
  />
</div>
```

4. For photos with empty URLs, show a placeholder instead of broken image:

```tsx
{photo.url && photo.url !== "" ? (
  <Image
    src={photo.thumbnailUrl || photo.url}
    alt={photo.caption || "Photo"}
    fill
    className="object-cover"
  />
) : (
  <div className="absolute inset-0 flex flex-col items-center justify-center bg-muted">
    <CloudOff className="h-8 w-8 text-muted-foreground mb-2" />
    <span className="text-xs text-muted-foreground">
      Pending sync
    </span>
  </div>
)}
```

5. Add visual indication when hovering on pending photos:

```tsx
<div
  className={cn(
    "relative aspect-square rounded-lg overflow-hidden cursor-pointer",
    "hover:ring-2 hover:ring-primary transition-all",
    !photo.url && "opacity-75 cursor-not-allowed"
  )}
  onClick={() => photo.url && onPhotoClick?.(photo)}
>
```

6. In the photo detail modal/panel, add hash verification status:

```tsx
{/* In photo detail view */}
<div className="flex items-center gap-2 mt-4">
  <span className="text-sm text-muted-foreground">Evidence Status:</span>
  <SyncStatusBadge
    status={deriveSyncStatus(photo)}
    hashVerified={photo.hashVerified}
    showLabel
    size="md"
  />
</div>
```

NOTE: The exact implementation depends on the current PhotoGallery.tsx structure. Read the file first and integrate the status badge appropriately while maintaining existing functionality.
  </action>
  <verify>
```bash
cd ../RANZ_Roofing_report && npx tsc --noEmit src/components/client/PhotoGallery.tsx
```
Verify that SyncStatusBadge is imported and used. Check that photos with empty URL show placeholder.
  </verify>
  <done>
PhotoGallery.tsx shows SyncStatusBadge for each photo. Photos with empty URL display placeholder instead of broken image. Hash verification status visible in photo details. Pending photos have reduced opacity and are not clickable.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds for both components
2. SyncStatusBadge renders correct icon for each status
3. deriveSyncStatus correctly identifies pending/synced/syncing states
4. Photo gallery shows badge on each thumbnail
5. Empty URL photos show placeholder with "Pending sync" message
6. Hash verification icon appears for synced photos
</verification>

<success_criteria>
- Sync status visible at a glance in photo gallery
- Pending photos clearly distinguished from synced photos
- Hash verification status visible (green shield = verified)
- Tooltips explain status meaning
- No broken images for pending uploads
- UI consistent with existing RANZ design system
</success_criteria>

<output>
After completion, create `.planning/phases/14-report-integration/14-04-SUMMARY.md`
</output>
