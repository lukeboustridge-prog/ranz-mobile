---
phase: 11-camera-gps-capture
plan: 05
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - src/lib/heic-utils.ts
  - src/services/photo-service.ts
autonomous: true

must_haves:
  truths:
    - "iOS HEIC photos are converted to JPEG for cross-platform compatibility"
    - "Conversion preserves GPS and timestamp metadata"
    - "Android JPEG photos pass through unchanged"
  artifacts:
    - path: "src/lib/heic-utils.ts"
      provides: "HEIC detection and format handling utilities"
      exports: ["isHEICFormat", "getPhotoMimeType"]
  key_links:
    - from: "src/services/photo-service.ts"
      to: "src/lib/heic-utils.ts"
      via: "import"
      pattern: "import.*isHEICFormat.*from.*heic-utils"
---

<objective>
Handle iOS HEIC photo format for cross-platform compatibility

Purpose: Ensure photos captured on iOS devices (which may use HEIC format) are converted to JPEG for compatibility with web platform, PDF generation, and external forensic tools.

Output:
- `src/lib/heic-utils.ts` - HEIC format detection utilities
- Updated photo-service.ts to handle HEIC format
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
Phase 11 requirement PLAT-03: App handles iOS HEIC photo format correctly

expo-camera behavior:
- By default, expo-camera returns JPEG format when using takePictureAsync
- The `skipProcessing: false` option ensures JPEG output
- If skipProcessing: true is used, iOS may return HEIC

Current photo-service.ts already uses `skipProcessing: false`, which should return JPEG.
However, we need detection utilities for future compatibility and handling edge cases.

Key insight from research:
- expo-camera with skipProcessing: false already handles conversion
- HEIC detection is useful for photos imported from camera roll (future feature)
- Format validation ensures consistent MIME type handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HEIC format utilities</name>
  <files>src/lib/heic-utils.ts</files>
  <action>
Create `src/lib/heic-utils.ts`:

```typescript
/**
 * HEIC Format Utilities
 * Detection and handling for iOS HEIC photo format
 *
 * expo-camera with skipProcessing: false returns JPEG by default.
 * These utilities are for:
 * 1. Validating photo format before processing
 * 2. Handling photos imported from camera roll (future feature)
 * 3. Ensuring consistent MIME type throughout the app
 */

import { Platform } from "react-native";

/**
 * HEIC magic bytes (first 12 bytes of file)
 * HEIC files start with 'ftyp' box containing 'heic', 'heix', 'hevc', or 'mif1'
 */
const HEIC_SIGNATURES = ["heic", "heix", "hevc", "mif1"];

/**
 * Check if a base64 string represents HEIC format
 *
 * @param base64Content - Base64 encoded file content
 * @returns true if content appears to be HEIC format
 *
 * @example
 * const isHeic = isHEICFormat(base64Content);
 * if (isHeic) {
 *   console.warn("HEIC detected - conversion may be needed");
 * }
 */
export function isHEICFormat(base64Content: string): boolean {
  try {
    // Decode first 24 bytes (enough to check ftyp box)
    const bytes = atob(base64Content.slice(0, 32));

    // HEIC ftyp box structure: [size(4)] [ftyp(4)] [brand(4)]
    // Brand is at bytes 8-11
    if (bytes.length < 12) return false;

    const brand = bytes.slice(8, 12).toLowerCase();
    return HEIC_SIGNATURES.some((sig) => brand.includes(sig));
  } catch {
    // If decoding fails, assume not HEIC
    return false;
  }
}

/**
 * Check if a file URI suggests HEIC format
 *
 * @param uri - File URI or path
 * @returns true if extension suggests HEIC format
 */
export function hasHEICExtension(uri: string): boolean {
  const lowerUri = uri.toLowerCase();
  return lowerUri.endsWith(".heic") || lowerUri.endsWith(".heif");
}

/**
 * Get appropriate MIME type for photo
 *
 * @param uri - File URI or path
 * @param base64Content - Optional base64 content for validation
 * @returns MIME type string
 */
export function getPhotoMimeType(uri: string, base64Content?: string): string {
  // Check extension first
  const lowerUri = uri.toLowerCase();

  if (lowerUri.endsWith(".heic") || lowerUri.endsWith(".heif")) {
    return "image/heic";
  }

  if (lowerUri.endsWith(".png")) {
    return "image/png";
  }

  // Default to JPEG for camera captures
  // expo-camera with skipProcessing: false returns JPEG
  return "image/jpeg";
}

/**
 * Determine if format conversion may be needed
 *
 * @param uri - File URI
 * @param targetFormat - Target format ("jpeg" | "png")
 * @returns true if conversion from HEIC may be needed
 */
export function needsFormatConversion(
  uri: string,
  targetFormat: "jpeg" | "png" = "jpeg"
): boolean {
  // Only iOS can produce HEIC
  if (Platform.OS !== "ios") {
    return false;
  }

  return hasHEICExtension(uri);
}

/**
 * Get file extension for MIME type
 *
 * @param mimeType - MIME type string
 * @returns File extension without dot
 */
export function getExtensionForMimeType(mimeType: string): string {
  switch (mimeType) {
    case "image/heic":
    case "image/heif":
      return "heic";
    case "image/png":
      return "png";
    case "image/jpeg":
    case "image/jpg":
    default:
      return "jpg";
  }
}

/**
 * Validate that photo is in acceptable format for evidence system
 *
 * @param mimeType - MIME type of the photo
 * @returns true if format is acceptable
 */
export function isAcceptableFormat(mimeType: string): boolean {
  const acceptable = [
    "image/jpeg",
    "image/jpg",
    "image/png",
    // HEIC is acceptable but may need conversion for web/PDF
    "image/heic",
    "image/heif",
  ];

  return acceptable.includes(mimeType.toLowerCase());
}

/**
 * Log format info for debugging
 *
 * @param uri - File URI
 * @param mimeType - Detected MIME type
 */
export function logFormatInfo(uri: string, mimeType: string): void {
  if (__DEV__) {
    console.log(`[HEIC Utils] File: ${uri.split("/").pop()}`);
    console.log(`[HEIC Utils] MIME: ${mimeType}`);
    console.log(`[HEIC Utils] Platform: ${Platform.OS}`);
    console.log(`[HEIC Utils] Needs conversion: ${needsFormatConversion(uri)}`);
  }
}
```
  </action>
  <verify>
File exists at src/lib/heic-utils.ts with all exports.
TypeScript compiles without errors.
  </verify>
  <done>
HEIC format utilities provide detection, MIME type handling, and conversion checking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add format validation to photo capture</name>
  <files>src/services/photo-service.ts</files>
  <action>
Add import at top of photo-service.ts:

```typescript
import { getPhotoMimeType, isAcceptableFormat, logFormatInfo } from "../lib/heic-utils";
```

In the capturePhoto method, after taking the picture (around line 262-268), add format validation:

Find:
```typescript
const photo = await cameraRef.takePictureAsync({
  quality: 0.9,
  exif: true,
  skipProcessing: false,
});
```

Add after:
```typescript
// Validate and log format
const detectedMimeType = getPhotoMimeType(photo.uri);
logFormatInfo(photo.uri, detectedMimeType);

if (!isAcceptableFormat(detectedMimeType)) {
  throw new Error(`Unsupported photo format: ${detectedMimeType}`);
}
```

Also update the LocalPhoto creation (around line 383) to use detected MIME type:

Find:
```typescript
mimeType: "image/jpeg",
```

Replace with:
```typescript
mimeType: detectedMimeType,
```

This ensures MIME type is correctly recorded based on actual file format.
  </action>
  <verify>
1. Format utilities imported in photo-service.ts
2. Format validation occurs after photo capture
3. MIME type is detected rather than hardcoded
4. TypeScript compiles without errors
  </verify>
  <done>
Photo capture validates format and uses detected MIME type.
  </done>
</task>

</tasks>

<verification>
1. HEIC utilities file exists with all exports
2. Photo capture validates format before processing
3. MIME type is dynamically detected
4. expo-camera still uses skipProcessing: false (ensures JPEG output)
5. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- HEIC format detection utilities available
- Photo capture validates format is acceptable
- MIME type correctly detected and stored
- No regression in existing JPEG capture flow
</success_criteria>

<output>
After completion, create `.planning/phases/11-camera-gps-capture/11-05-SUMMARY.md`
</output>
