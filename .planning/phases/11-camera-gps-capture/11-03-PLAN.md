---
phase: 11-camera-gps-capture
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/CameraCapture.tsx
  - src/services/photo-service.ts
autonomous: true

must_haves:
  truths:
    - "GPS accuracy indicator is visible in camera UI"
    - "Location validation alerts inspector if capture is far from property"
    - "iOS approximate location (accuracy > 1000m) shows warning"
  artifacts:
    - path: "src/components/CameraCapture.tsx"
      provides: "Camera UI with GPS accuracy display and location validation"
      contains: "validateCaptureLocation"
  key_links:
    - from: "src/components/CameraCapture.tsx"
      to: "src/lib/location-utils.ts"
      via: "import"
      pattern: "import.*validateCaptureLocation.*from.*location-utils"
---

<objective>
Add location validation and GPS accuracy UI to camera capture

Purpose: Ensure inspectors know their GPS signal quality and receive alerts when capturing photos far from the expected property location.

Output:
- Enhanced CameraCapture.tsx with location validation alerts
- GPS accuracy indicator showing approximate location warning on iOS
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
From Plan 11-01:
- src/lib/location-utils.ts provides validateCaptureLocation, isApproximateLocation, formatGPSAccuracy

Existing CameraCapture.tsx:
@ranz-mobile/src/components/CameraCapture.tsx

Current GPS UI (lines 206-215):
- Shows GPS accuracy in meters (good/fair/poor/none)
- Uses colored dot indicator

Enhancement needed:
1. Add location validation against property address
2. Show warning when accuracy > 1000m (iOS approximate)
3. Alert on capture if location is far from property
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add location utilities imports and prop for property location</name>
  <files>src/components/CameraCapture.tsx</files>
  <action>
Add imports at the top of the file:

```typescript
import {
  validateCaptureLocation,
  isApproximateLocation,
  formatGPSAccuracy,
} from "../lib/location-utils";
```

Update the CameraCaptureProps interface to accept property coordinates:

```typescript
interface CameraCaptureProps {
  reportId: string;
  defectId?: string;
  roofElementId?: string;
  roofElements?: RoofElementOption[];
  propertyLocation?: { latitude: number; longitude: number }; // NEW
  onCapture: (photoId: string, quickTag?: QuickTag, elementId?: string) => void;
  onClose: () => void;
}
```

Update function signature to accept the new prop:

```typescript
export function CameraCapture({
  reportId,
  defectId,
  roofElementId: initialElementId,
  roofElements = [],
  propertyLocation, // NEW
  onCapture,
  onClose,
}: CameraCaptureProps) {
```
  </action>
  <verify>
Imports added. Props interface includes propertyLocation. No TypeScript errors.
  </verify>
  <done>
Location utilities imported and propertyLocation prop added to CameraCapture.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add approximate location warning to GPS indicator</name>
  <files>src/components/CameraCapture.tsx</files>
  <action>
Add state for approximate location warning:

```typescript
const [isApproximate, setIsApproximate] = useState(false);
```

Update the GPS status interval (in useEffect around line 99-107) to check for approximate location:

```typescript
// Update GPS status every second
const interval = setInterval(() => {
  const status = getGPSAccuracyStatus();
  setGpsStatus(status);

  // Check for iOS approximate location
  setIsApproximate(isApproximateLocation(status.accuracy));

  const loc = getCurrentLocation();
  if (loc) {
    setLocation({ lat: loc.latitude, lng: loc.longitude });
  }
}, 1000);
```

Update the GPS container display (around line 206-215) to show approximate warning:

Find:
```typescript
<View style={styles.gpsContainer}>
  <View style={[styles.gpsDot, { backgroundColor: getGpsColor() }]} />
  <Text style={styles.gpsText}>
    GPS: {gpsStatus.status === "none" ? "No signal" : `±${Math.round(gpsStatus.accuracy)}m`}
  </Text>
</View>
```

Replace with:
```typescript
<View style={styles.gpsContainer}>
  <View style={[styles.gpsDot, { backgroundColor: getGpsColor() }]} />
  <Text style={styles.gpsText}>
    GPS: {gpsStatus.status === "none" ? "No signal" : `±${Math.round(gpsStatus.accuracy)}m`}
  </Text>
  {isApproximate && (
    <Text style={styles.approximateWarning}>APPROX</Text>
  )}
</View>
```

Add the style for approximate warning:
```typescript
approximateWarning: {
  color: "#f59e0b",
  fontSize: 10,
  fontWeight: "700",
  marginLeft: 4,
  backgroundColor: "rgba(245,158,11,0.2)",
  paddingHorizontal: 4,
  paddingVertical: 1,
  borderRadius: 2,
},
```
  </action>
  <verify>
1. isApproximate state exists
2. GPS container shows "APPROX" badge when accuracy > 1000m
3. Style for approximateWarning defined
  </verify>
  <done>
iOS approximate location shows "APPROX" warning badge next to GPS indicator.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add location validation alert on capture</name>
  <files>src/components/CameraCapture.tsx</files>
  <action>
Add state for location validation warning:

```typescript
const [locationWarning, setLocationWarning] = useState<string | null>(null);
```

Update the handleCapture function to validate location before capture:

Find the start of handleCapture (around line 120):
```typescript
const handleCapture = async () => {
  if (!cameraRef.current || isCapturing) return;

  setIsCapturing(true);
  setCaptureStatus("Capturing...");
```

Insert location validation after setIsCapturing:
```typescript
const handleCapture = async () => {
  if (!cameraRef.current || isCapturing) return;

  setIsCapturing(true);
  setCaptureStatus("Capturing...");

  // Validate capture location against property
  if (propertyLocation && location) {
    const validation = validateCaptureLocation(
      { latitude: location.lat, longitude: location.lng },
      propertyLocation,
      500 // 500m threshold
    );

    if (!validation.isValid && validation.distanceMeters) {
      const distanceKm = (validation.distanceMeters / 1000).toFixed(1);
      setLocationWarning(`Warning: ${distanceKm}km from property`);
      // Don't block capture, just warn
      setTimeout(() => setLocationWarning(null), 5000);
    }
  }
```

Add UI for location warning overlay (before the Capture Status overlay, around line 238):
```typescript
{/* Location Warning */}
{locationWarning && (
  <View style={styles.locationWarningOverlay}>
    <Text style={styles.locationWarningText}>{locationWarning}</Text>
  </View>
)}
```

Add styles:
```typescript
locationWarningOverlay: {
  position: "absolute",
  top: 100,
  left: 16,
  right: 16,
  backgroundColor: "rgba(245, 158, 11, 0.9)",
  paddingHorizontal: 16,
  paddingVertical: 10,
  borderRadius: 8,
  alignItems: "center",
},
locationWarningText: {
  color: "#fff",
  fontSize: 14,
  fontWeight: "600",
  textAlign: "center",
},
```
  </action>
  <verify>
1. locationWarning state exists
2. validateCaptureLocation called in handleCapture when propertyLocation provided
3. Warning overlay displays when capture location far from property
4. Warning auto-dismisses after 5 seconds
5. Capture is NOT blocked by location warning (non-blocking alert)
  </verify>
  <done>
Location validation alerts inspector when capturing photos far from property address, without blocking capture.
  </done>
</task>

</tasks>

<verification>
1. CameraCapture renders with GPS accuracy indicator
2. "APPROX" badge appears when accuracy > 1000m
3. Location warning shows when capture > 500m from property
4. Capture still works even with location warning
5. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- GPS accuracy indicator visible in camera UI
- Approximate location warning displayed on iOS when precise location denied
- Location validation alerts inspector if capture location far from property
- Capture is NOT blocked by location warnings (non-blocking UX)
</success_criteria>

<output>
After completion, create `.planning/phases/11-camera-gps-capture/11-03-SUMMARY.md`
</output>
