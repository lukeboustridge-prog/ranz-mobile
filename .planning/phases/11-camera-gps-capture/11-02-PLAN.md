---
phase: 11-camera-gps-capture
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/services/photo-service.ts
autonomous: true

must_haves:
  truths:
    - "Captured photos contain GPS coordinates in EXIF metadata readable by external tools"
    - "Original hash is generated BEFORE EXIF embedding"
    - "Working copy has EXIF GPS embedded for external tool compatibility"
  artifacts:
    - path: "src/services/photo-service.ts"
      provides: "Photo capture with EXIF GPS embedding"
      contains: "embedGPSInEXIF"
  key_links:
    - from: "src/services/photo-service.ts"
      to: "src/lib/exif-utils.ts"
      via: "import embedGPSInEXIF"
      pattern: "import.*embedGPSInEXIF.*from.*exif-utils"
---

<objective>
Integrate GPS EXIF embedding into photo capture workflow

Purpose: Ensure captured photos have GPS coordinates embedded in EXIF metadata so external forensic tools and court systems can verify location data.

Output:
- Updated photo-service.ts with dual-hash strategy: hash original, then embed GPS in working copy
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
From Plan 11-01:
- src/lib/exif-utils.ts provides embedGPSInEXIF(base64, gps)
- src/lib/location-utils.ts provides location validation utilities

Existing photo-service.ts:
@ranz-mobile/src/services/photo-service.ts

Current flow:
1. Capture photo
2. Read as base64
3. Generate hash from base64 (GOOD - hash BEFORE file ops)
4. Copy to originals (immutable)
5. Copy to working directory

New flow (dual-hash strategy from research):
1. Capture photo
2. Read as base64
3. Generate hash from base64 (originalHash - for immutable file)
4. Copy to originals (immutable, NO EXIF modification)
5. Embed GPS in base64 using piexifjs (creates new content)
6. Write EXIF-embedded version to working directory
7. (Optional) Generate workingHash for the EXIF-embedded file

CRITICAL: The original in originals/ must NEVER have EXIF modified post-capture.
The working copy in photos/ CAN have embedded GPS for tool compatibility.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update photo-service imports</name>
  <files>src/services/photo-service.ts</files>
  <action>
Add import for EXIF utilities at the top of the file:

```typescript
import { embedGPSInEXIF } from "../lib/exif-utils";
```

This enables GPS EXIF embedding in the capture workflow.
  </action>
  <verify>
Import statement exists. No TypeScript import errors.
  </verify>
  <done>
embedGPSInEXIF is imported from exif-utils.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement dual-hash GPS EXIF embedding in capturePhoto</name>
  <files>src/services/photo-service.ts</files>
  <action>
Modify the `capturePhoto` method in the PhotoService class to embed GPS in the working copy:

Find the section after hash generation and original storage (around line 300-315):

```typescript
// Copy to working photos directory (for display/annotation)
const workingPath = getWorkingPath(filename);
await copyAsync({
  from: photo.uri,
  to: workingPath,
});
```

Replace with GPS EXIF embedding:

```typescript
// =========================================
// WORKING COPY: Embed GPS in EXIF for external tool compatibility
// =========================================
this.emitProgress("Embedding GPS in working copy...");

let workingBase64 = base64Content;

// Only embed GPS if we have valid coordinates
if (gpsData && gpsData.latitude && gpsData.longitude) {
  try {
    workingBase64 = await embedGPSInEXIF(base64Content, {
      lat: gpsData.latitude,
      lng: gpsData.longitude,
      altitude: gpsData.altitude ?? undefined,
      timestamp: timestamp,
    });
    photoLogger.debug("GPS embedded in working copy EXIF", {
      lat: gpsData.latitude.toFixed(6),
      lng: gpsData.longitude.toFixed(6),
    });
  } catch (exifError) {
    // Non-fatal: working copy will just not have EXIF GPS
    // Original hash and metadata are still valid
    photoLogger.warn("Failed to embed GPS in EXIF, using original", {
      error: exifError instanceof Error ? exifError.message : "Unknown error",
    });
  }
}

// Write working copy (with or without embedded GPS)
const workingPath = getWorkingPath(filename);
await writeAsStringAsync(workingPath, workingBase64, {
  encoding: EncodingType.Base64,
});
```

Also add the required import at the top:
```typescript
import { writeAsStringAsync } from "expo-file-system/legacy";
```

Remove the copyAsync call for working copy and use writeAsStringAsync with the potentially GPS-embedded base64.

IMPORTANT:
- The original file in originals/ remains untouched (preserves original hash)
- The working copy in photos/ has embedded GPS for tool compatibility
- If EXIF embedding fails, gracefully fall back to original content
  </action>
  <verify>
1. capturePhoto method calls embedGPSInEXIF when GPS data is available
2. writeAsStringAsync is imported
3. Working copy is written with writeAsStringAsync, not copyAsync
4. Error handling exists for EXIF embedding failures
  </verify>
  <done>
Photo capture embeds GPS in working copy EXIF while preserving original hash for evidence integrity.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update chain of custody logging for EXIF embedding</name>
  <files>src/services/photo-service.ts</files>
  <action>
After the GPS embedding section, update the STORED custody event to indicate EXIF status:

Find the logStorage call (around line 340-348):

```typescript
// Log STORED event
await logStorage(
  "photo",
  id,
  userId,
  userName,
  originalHash,
  originalPath
);
```

Update the details to indicate EXIF embedding status:

```typescript
// Log STORED event with EXIF embedding status
const exifEmbedded = gpsData && gpsData.latitude && gpsData.longitude;
await logStorage(
  "photo",
  id,
  userId,
  userName,
  originalHash,
  originalPath
);

// Log a separate event for EXIF embedding if GPS was embedded
if (exifEmbedded) {
  await logCapture(
    "photo",
    id,
    userId,
    userName,
    originalHash,
    `GPS EXIF embedded in working copy: ${gpsData.latitude.toFixed(6)}, ${gpsData.longitude.toFixed(6)}`
  );
}
```

This creates an audit trail showing that GPS was embedded in the working copy.
  </action>
  <verify>
Chain of custody includes EXIF embedding event when GPS is present.
  </verify>
  <done>
Audit trail includes GPS EXIF embedding status for forensic evidence chain.
  </done>
</task>

</tasks>

<verification>
1. Photo capture flow completes without errors
2. Working copy has GPS in EXIF when GPS data is available
3. Original file hash remains unchanged
4. Chain of custody logs EXIF embedding
5. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- embedGPSInEXIF is called during photo capture when GPS is available
- Working copy is written with writeAsStringAsync (not copyAsync)
- Error handling prevents capture failure if EXIF embedding fails
- Chain of custody logs GPS EXIF embedding event
</success_criteria>

<output>
After completion, create `.planning/phases/11-camera-gps-capture/11-02-SUMMARY.md`
</output>
