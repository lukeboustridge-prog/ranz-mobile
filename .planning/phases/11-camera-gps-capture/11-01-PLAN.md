---
phase: 11-camera-gps-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/exif-utils.ts
  - src/lib/location-utils.ts
autonomous: true

must_haves:
  truths:
    - "GPS coordinates can be embedded into JPEG EXIF metadata"
    - "Haversine distance calculation returns accurate results"
    - "Degree to DMS conversion follows EXIF GPS specification"
  artifacts:
    - path: "src/lib/exif-utils.ts"
      provides: "GPS EXIF embedding utilities using piexifjs"
      exports: ["embedGPSInEXIF", "degToDmsRational"]
    - path: "src/lib/location-utils.ts"
      provides: "Location validation and distance calculation"
      exports: ["calculateHaversineDistance", "validateCaptureLocation"]
  key_links:
    - from: "src/lib/exif-utils.ts"
      to: "piexifjs"
      via: "npm import"
      pattern: "import.*piexifjs"
---

<objective>
Create GPS EXIF embedding and location validation utilities

Purpose: Enable photos to contain GPS coordinates in EXIF metadata (readable by external tools) and validate capture location against expected property address.

Output:
- `src/lib/exif-utils.ts` - GPS EXIF embedding using piexifjs with dual-hash strategy
- `src/lib/location-utils.ts` - Haversine distance calculation and location validation
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
Phase 11 research established:
- expo-camera additionalExif has limited Android GPS support - use piexifjs post-capture
- Dual-hash strategy: hash original BEFORE EXIF, then create EXIF-embedded working copy
- piexifjs uses degToDmsRational helper for GPS coordinate conversion
- Haversine formula for location validation (500m threshold configurable)

Existing code:
@ranz-mobile/src/services/evidence-service.ts - Hash generation utilities
@ranz-mobile/src/lib/file-storage.ts - Storage paths and file operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install piexifjs dependency</name>
  <files>package.json</files>
  <action>
Install piexifjs for EXIF manipulation:

```bash
cd ranz-mobile && npm install piexifjs
```

piexifjs is a pure JavaScript library that works in React Native for reading/writing EXIF data.
  </action>
  <verify>
Run `npm ls piexifjs` and confirm it appears in dependencies.
  </verify>
  <done>
piexifjs is listed in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EXIF utilities with GPS embedding</name>
  <files>src/lib/exif-utils.ts</files>
  <action>
Create `src/lib/exif-utils.ts` with:

1. **degToDmsRational(deg: number)** - Convert decimal degrees to EXIF DMS rational format
   - EXIF stores GPS as [[degrees,1], [minutes,1], [seconds*10000,10000]]
   - Handle negative values (for S/W coordinates) by returning absolute value + ref indicator

2. **embedGPSInEXIF(base64Jpeg: string, gps: {lat, lng, altitude?, timestamp?})** - Embed GPS data into JPEG
   - Parse existing EXIF using piexif.load()
   - Add GPS IFD with:
     - GPSLatitude, GPSLatitudeRef (N/S)
     - GPSLongitude, GPSLongitudeRef (E/W)
     - GPSAltitude, GPSAltitudeRef (if altitude provided)
     - GPSDateStamp, GPSTimeStamp (if timestamp provided)
   - Return new base64 JPEG with embedded GPS
   - CRITICAL: This creates a NEW file - do NOT modify the original

3. **extractGPSFromEXIF(base64Jpeg: string)** - Read GPS from EXIF for verification
   - Return { lat, lng, altitude?, hasGPS: boolean }

Include TypeScript types and JSDoc comments.

Example degToDmsRational implementation:
```typescript
export function degToDmsRational(deg: number): [[number, number], [number, number], [number, number]] {
  const absDeg = Math.abs(deg);
  const d = Math.floor(absDeg);
  const minFloat = (absDeg - d) * 60;
  const m = Math.floor(minFloat);
  const secFloat = (minFloat - m) * 60;
  // Use rational format: [numerator, denominator] for precision
  const s = Math.round(secFloat * 10000);
  return [[d, 1], [m, 1], [s, 10000]];
}
```
  </action>
  <verify>
File exists at src/lib/exif-utils.ts with exports for degToDmsRational, embedGPSInEXIF, extractGPSFromEXIF.
TypeScript compilation passes (no type errors).
  </verify>
  <done>
EXIF utilities file exists with GPS embedding capabilities. degToDmsRational correctly converts coordinates. embedGPSInEXIF returns modified base64 JPEG.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create location validation utilities</name>
  <files>src/lib/location-utils.ts</files>
  <action>
Create `src/lib/location-utils.ts` with:

1. **calculateHaversineDistance(lat1, lng1, lat2, lng2)** - Calculate distance between two GPS points
   - Return distance in meters
   - Use Earth radius = 6371000 meters
   - Handle edge cases (same point = 0, antipodal points)

2. **validateCaptureLocation(captureLocation, propertyLocation, thresholdMeters = 500)**
   - Return { isValid: boolean, distanceMeters: number, message: string }
   - If captureLocation is null/undefined, return { isValid: false, message: "No GPS signal" }
   - If propertyLocation is null/undefined, return { isValid: true, message: "No property location to validate against" }
   - If within threshold: { isValid: true, message: "Within expected range" }
   - If outside threshold: { isValid: false, message: `Capture location is ${distance}m from property` }

3. **isApproximateLocation(accuracy: number)** - Detect iOS approximate location
   - Return true if accuracy > 1000m (iOS approximate location indicator)
   - Used to alert user they should enable precise location

4. **formatGPSAccuracy(accuracy: number)** - Human-readable accuracy string
   - < 10m: "Excellent"
   - 10-30m: "Good"
   - 30-100m: "Fair"
   - 100-1000m: "Poor"
   - > 1000m: "Approximate only"

Include TypeScript interfaces:
```typescript
interface GPSCoordinates {
  latitude: number;
  longitude: number;
}

interface LocationValidationResult {
  isValid: boolean;
  distanceMeters: number | null;
  message: string;
}
```
  </action>
  <verify>
File exists at src/lib/location-utils.ts with all exports.
Haversine calculation is correct: distance between Auckland CBD (-36.8485, 174.7633) and ~500m away should return ~500m.
TypeScript compilation passes.
  </verify>
  <done>
Location utilities file exists with Haversine distance calculation, location validation, and approximate location detection.
  </done>
</task>

</tasks>

<verification>
1. Both utility files exist and export all required functions
2. TypeScript compilation succeeds: `npx tsc --noEmit`
3. piexifjs is in package.json dependencies
4. No new lint errors: `npm run lint` (if lint script exists)
</verification>

<success_criteria>
- piexifjs installed as dependency
- src/lib/exif-utils.ts exports degToDmsRational, embedGPSInEXIF, extractGPSFromEXIF
- src/lib/location-utils.ts exports calculateHaversineDistance, validateCaptureLocation, isApproximateLocation
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-camera-gps-capture/11-01-SUMMARY.md`
</output>
