---
phase: 11-camera-gps-capture
plan: 04
type: execute
wave: 3
depends_on: ["11-02", "11-03"]
files_modified:
  - src/hooks/usePermissions.ts
  - src/components/PermissionGate.tsx
autonomous: true

must_haves:
  truths:
    - "Camera permission is requested appropriately on iOS and Android"
    - "Location permission is requested with proper rationale"
    - "Permission denied state shows helpful guidance to user"
  artifacts:
    - path: "src/hooks/usePermissions.ts"
      provides: "Unified permission hook for camera and location"
      exports: ["usePermissions"]
    - path: "src/components/PermissionGate.tsx"
      provides: "Component that handles permission request flow"
      exports: ["PermissionGate"]
  key_links:
    - from: "src/hooks/usePermissions.ts"
      to: "expo-camera"
      via: "import"
      pattern: "import.*Camera.*from.*expo-camera"
    - from: "src/hooks/usePermissions.ts"
      to: "expo-location"
      via: "import"
      pattern: "import.*Location.*from.*expo-location"
---

<objective>
Create unified permission handling for camera and location

Purpose: Ensure camera and location permissions are requested appropriately on both iOS and Android with proper user guidance when permissions are denied.

Output:
- `src/hooks/usePermissions.ts` - Hook for checking and requesting permissions
- `src/components/PermissionGate.tsx` - Component that wraps camera requiring permissions
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
Phase 11 requirements:
- PLAT-04: App handles iOS and Android permission models

Existing permission handling in photo-service.ts:
- requestCameraPermission() - basic camera permission
- requestLocationPermission() - basic location permission

Enhancement needed:
1. Unified hook that manages both permissions
2. Permission state tracking (granted, denied, undetermined)
3. UI component for permission request flow
4. Guidance for users when permissions denied (link to settings)

Platform differences:
- iOS: NSCameraUsageDescription and NSLocationWhenInUseUsageDescription in Info.plist
- Android: Permissions in AndroidManifest.xml, runtime request for camera/location
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePermissions hook</name>
  <files>src/hooks/usePermissions.ts</files>
  <action>
Create `src/hooks/usePermissions.ts`:

```typescript
/**
 * usePermissions Hook
 * Unified permission management for camera and location
 */

import { useState, useEffect, useCallback } from "react";
import * as Camera from "expo-camera";
import * as Location from "expo-location";
import { Platform, Linking } from "react-native";

export type PermissionStatus = "undetermined" | "granted" | "denied";

export interface PermissionState {
  camera: PermissionStatus;
  location: PermissionStatus;
  locationPrecise: boolean; // iOS 14+ can grant approximate vs precise
}

export interface UsePermissionsReturn {
  permissions: PermissionState;
  isLoading: boolean;
  allGranted: boolean;
  requestCameraPermission: () => Promise<boolean>;
  requestLocationPermission: () => Promise<boolean>;
  requestAllPermissions: () => Promise<boolean>;
  openSettings: () => void;
}

export function usePermissions(): UsePermissionsReturn {
  const [permissions, setPermissions] = useState<PermissionState>({
    camera: "undetermined",
    location: "undetermined",
    locationPrecise: false,
  });
  const [isLoading, setIsLoading] = useState(true);

  // Check current permission status on mount
  useEffect(() => {
    checkPermissions();
  }, []);

  const checkPermissions = async () => {
    setIsLoading(true);
    try {
      const [cameraStatus, locationStatus] = await Promise.all([
        Camera.Camera.getCameraPermissionsAsync(),
        Location.getForegroundPermissionsAsync(),
      ]);

      setPermissions({
        camera: mapStatus(cameraStatus.status),
        location: mapStatus(locationStatus.status),
        // iOS 14+: check if user granted precise location
        locationPrecise: Platform.OS === "ios"
          ? (locationStatus as any).accuracy === "full"
          : true,
      });
    } catch (error) {
      console.error("Error checking permissions:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const mapStatus = (status: string): PermissionStatus => {
    switch (status) {
      case "granted":
        return "granted";
      case "denied":
        return "denied";
      default:
        return "undetermined";
    }
  };

  const requestCameraPermission = useCallback(async (): Promise<boolean> => {
    const { status } = await Camera.Camera.requestCameraPermissionsAsync();
    const granted = status === "granted";
    setPermissions((prev) => ({ ...prev, camera: granted ? "granted" : "denied" }));
    return granted;
  }, []);

  const requestLocationPermission = useCallback(async (): Promise<boolean> => {
    const { status } = await Location.requestForegroundPermissionsAsync();
    const granted = status === "granted";

    // On iOS, also check if we got precise location
    if (Platform.OS === "ios" && granted) {
      const fullStatus = await Location.getForegroundPermissionsAsync();
      setPermissions((prev) => ({
        ...prev,
        location: "granted",
        locationPrecise: (fullStatus as any).accuracy === "full",
      }));
    } else {
      setPermissions((prev) => ({
        ...prev,
        location: granted ? "granted" : "denied",
        locationPrecise: granted,
      }));
    }

    return granted;
  }, []);

  const requestAllPermissions = useCallback(async (): Promise<boolean> => {
    const [camera, location] = await Promise.all([
      requestCameraPermission(),
      requestLocationPermission(),
    ]);
    return camera && location;
  }, [requestCameraPermission, requestLocationPermission]);

  const openSettings = useCallback(() => {
    if (Platform.OS === "ios") {
      Linking.openURL("app-settings:");
    } else {
      Linking.openSettings();
    }
  }, []);

  const allGranted = permissions.camera === "granted" && permissions.location === "granted";

  return {
    permissions,
    isLoading,
    allGranted,
    requestCameraPermission,
    requestLocationPermission,
    requestAllPermissions,
    openSettings,
  };
}
```
  </action>
  <verify>
File exists at src/hooks/usePermissions.ts with usePermissions export.
TypeScript compiles without errors.
  </verify>
  <done>
usePermissions hook provides unified permission management with status tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionGate component</name>
  <files>src/components/PermissionGate.tsx</files>
  <action>
Create `src/components/PermissionGate.tsx`:

```typescript
/**
 * PermissionGate Component
 * Wraps camera UI and handles permission request flow
 */

import React from "react";
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  SafeAreaView,
  ActivityIndicator,
} from "react-native";
import { usePermissions, PermissionStatus } from "../hooks/usePermissions";

interface PermissionGateProps {
  children: React.ReactNode;
  onClose?: () => void;
}

export function PermissionGate({ children, onClose }: PermissionGateProps) {
  const {
    permissions,
    isLoading,
    allGranted,
    requestAllPermissions,
    openSettings,
  } = usePermissions();

  if (isLoading) {
    return (
      <SafeAreaView style={styles.container}>
        <ActivityIndicator size="large" color="#2d5c8f" />
        <Text style={styles.loadingText}>Checking permissions...</Text>
      </SafeAreaView>
    );
  }

  if (allGranted) {
    return <>{children}</>;
  }

  const anyDenied = permissions.camera === "denied" || permissions.location === "denied";

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.content}>
        <Text style={styles.title}>Camera Access Required</Text>

        <Text style={styles.description}>
          To capture inspection photos with GPS data for evidence integrity,
          we need access to your camera and location.
        </Text>

        <View style={styles.permissionList}>
          <PermissionItem
            label="Camera"
            status={permissions.camera}
            reason="To capture inspection photos"
          />
          <PermissionItem
            label="Location"
            status={permissions.location}
            reason="To record GPS coordinates in photos"
          />
          {permissions.location === "granted" && !permissions.locationPrecise && (
            <View style={styles.precisionWarning}>
              <Text style={styles.precisionWarningText}>
                Approximate location only. For accurate evidence, enable precise
                location in Settings.
              </Text>
            </View>
          )}
        </View>

        {anyDenied ? (
          <View style={styles.deniedSection}>
            <Text style={styles.deniedText}>
              Permissions were denied. Please enable them in your device settings.
            </Text>
            <TouchableOpacity style={styles.settingsButton} onPress={openSettings}>
              <Text style={styles.settingsButtonText}>Open Settings</Text>
            </TouchableOpacity>
          </View>
        ) : (
          <TouchableOpacity
            style={styles.grantButton}
            onPress={requestAllPermissions}
          >
            <Text style={styles.grantButtonText}>Grant Permissions</Text>
          </TouchableOpacity>
        )}

        {onClose && (
          <TouchableOpacity style={styles.closeButton} onPress={onClose}>
            <Text style={styles.closeButtonText}>Cancel</Text>
          </TouchableOpacity>
        )}
      </View>
    </SafeAreaView>
  );
}

interface PermissionItemProps {
  label: string;
  status: PermissionStatus;
  reason: string;
}

function PermissionItem({ label, status, reason }: PermissionItemProps) {
  const statusIcon = {
    undetermined: "○",
    granted: "✓",
    denied: "✗",
  };

  const statusColor = {
    undetermined: "#6b7280",
    granted: "#22c55e",
    denied: "#ef4444",
  };

  return (
    <View style={styles.permissionItem}>
      <Text style={[styles.statusIcon, { color: statusColor[status] }]}>
        {statusIcon[status]}
      </Text>
      <View style={styles.permissionInfo}>
        <Text style={styles.permissionLabel}>{label}</Text>
        <Text style={styles.permissionReason}>{reason}</Text>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: "#0c1929",
    justifyContent: "center",
    alignItems: "center",
  },
  loadingText: {
    color: "#fff",
    marginTop: 16,
    fontSize: 16,
  },
  content: {
    paddingHorizontal: 24,
    maxWidth: 400,
    width: "100%",
  },
  title: {
    color: "#fff",
    fontSize: 24,
    fontWeight: "700",
    textAlign: "center",
    marginBottom: 16,
  },
  description: {
    color: "#a3bed9",
    fontSize: 16,
    textAlign: "center",
    lineHeight: 24,
    marginBottom: 32,
  },
  permissionList: {
    marginBottom: 32,
  },
  permissionItem: {
    flexDirection: "row",
    alignItems: "center",
    backgroundColor: "rgba(255,255,255,0.05)",
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderRadius: 8,
    marginBottom: 8,
  },
  statusIcon: {
    fontSize: 20,
    fontWeight: "700",
    marginRight: 12,
  },
  permissionInfo: {
    flex: 1,
  },
  permissionLabel: {
    color: "#fff",
    fontSize: 16,
    fontWeight: "600",
  },
  permissionReason: {
    color: "#a3bed9",
    fontSize: 14,
    marginTop: 2,
  },
  precisionWarning: {
    backgroundColor: "rgba(245,158,11,0.15)",
    padding: 12,
    borderRadius: 8,
    marginTop: 8,
  },
  precisionWarningText: {
    color: "#f59e0b",
    fontSize: 13,
    lineHeight: 18,
  },
  deniedSection: {
    alignItems: "center",
  },
  deniedText: {
    color: "#ef4444",
    fontSize: 14,
    textAlign: "center",
    marginBottom: 16,
  },
  settingsButton: {
    backgroundColor: "#2d5c8f",
    paddingVertical: 14,
    paddingHorizontal: 32,
    borderRadius: 8,
    width: "100%",
    alignItems: "center",
  },
  settingsButtonText: {
    color: "#fff",
    fontSize: 16,
    fontWeight: "600",
  },
  grantButton: {
    backgroundColor: "#2d5c8f",
    paddingVertical: 14,
    paddingHorizontal: 32,
    borderRadius: 8,
    alignItems: "center",
  },
  grantButtonText: {
    color: "#fff",
    fontSize: 16,
    fontWeight: "600",
  },
  closeButton: {
    marginTop: 16,
    paddingVertical: 12,
    alignItems: "center",
  },
  closeButtonText: {
    color: "#a3bed9",
    fontSize: 16,
  },
});

export default PermissionGate;
```
  </action>
  <verify>
File exists at src/components/PermissionGate.tsx.
Component handles loading, granted, denied, and undetermined states.
TypeScript compiles without errors.
  </verify>
  <done>
PermissionGate component wraps camera UI with permission request flow and denied state guidance.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export new components from index files</name>
  <files>src/hooks/index.ts, src/components/index.ts</files>
  <action>
If src/hooks/index.ts exists, add export:
```typescript
export * from "./usePermissions";
```

If src/components/index.ts exists, add export:
```typescript
export * from "./PermissionGate";
```

If the index files don't exist, create them with just the new exports (and any existing exports from other files in those directories).
  </action>
  <verify>
usePermissions and PermissionGate are exported from their respective index files (if index files exist).
  </verify>
  <done>
New permission hook and component are properly exported.
  </done>
</task>

</tasks>

<verification>
1. usePermissions hook exists and exports correctly
2. PermissionGate component renders permission request UI
3. Permission denied state shows "Open Settings" button
4. iOS approximate location warning displays when relevant
5. TypeScript compilation passes: `npx tsc --noEmit`
</verification>

<success_criteria>
- usePermissions hook provides camera, location, and precise location status
- PermissionGate shows appropriate UI for undetermined, granted, and denied states
- "Open Settings" button works on both iOS and Android
- iOS approximate location warning is displayed
</success_criteria>

<output>
After completion, create `.planning/phases/11-camera-gps-capture/11-04-SUMMARY.md`
</output>
