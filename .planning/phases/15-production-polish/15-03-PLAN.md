---
phase: 15-production-polish
plan: 03
type: execute
wave: 2
depends_on: ["15-02"]
files_modified:
  - app.json
  - app/_layout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Sentry SDK is initialized on app start"
    - "Sentry only reports in preview and production (not development)"
    - "Error boundaries report to Sentry"
    - "Sentry config plugin is added to app.json for sourcemaps"
  artifacts:
    - path: "app/_layout.tsx"
      provides: "Sentry initialization and wrap"
      contains: "Sentry.init"
    - path: "app.json"
      provides: "Sentry expo plugin configuration"
      contains: "@sentry/react-native/expo"
    - path: "package.json"
      provides: "Sentry dependencies"
      contains: "@sentry/react-native"
  key_links:
    - from: "app/_layout.tsx"
      to: "src/config/environment.ts"
      via: "config.sentryDsn"
      pattern: "config\\.sentryDsn"
---

<objective>
Integrate Sentry for crash reporting and performance monitoring.

Purpose: Production apps need crash visibility. Sentry provides stack traces with sourcemaps, performance metrics, and session replay. Disabled in development to avoid noise.

Output: Sentry initialized in root layout, configured in app.json for sourcemap uploads.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-polish/15-RESEARCH.md

@app/_layout.tsx
@app.json
@package.json
@src/config/environment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sentry dependencies</name>
  <files>package.json</files>
  <action>
Install Sentry for React Native using Expo's recommended method:

```bash
npx expo install @sentry/react-native
```

This installs the version compatible with the current Expo SDK (54).

Note: The research mentioned potential compatibility issues with Expo 54 preview versions. After installation, verify the installed version. If there are issues, the research suggests checking GitHub issues for @sentry/react-native.

After installation, verify package.json includes @sentry/react-native in dependencies.
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && grep "@sentry/react-native" package.json
```
  </verify>
  <done>
@sentry/react-native is installed and listed in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Sentry plugin in app.json</name>
  <files>app.json</files>
  <action>
Add the Sentry config plugin to app.json for sourcemap uploads:

1. Read current app.json
2. Add Sentry plugin to the plugins array:

```json
{
  "expo": {
    "plugins": [
      // ... existing plugins (expo-router, expo-camera, etc.)
      [
        "@sentry/react-native/expo",
        {
          "organization": "ranz",
          "project": "ranz-mobile"
        }
      ]
    ]
  }
}
```

Insert the Sentry plugin at the END of the plugins array (after expo-background-task).

The organization and project names should match the Sentry project that will be created. These can be updated later if RANZ uses a different naming convention.

Note: SENTRY_AUTH_TOKEN will be set in EAS secrets during deployment, not in app.json.
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && grep -A 5 "@sentry/react-native/expo" app.json
```
  </verify>
  <done>
app.json plugins array includes @sentry/react-native/expo with organization and project config.
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize Sentry in root layout</name>
  <files>app/_layout.tsx</files>
  <action>
Update `app/_layout.tsx` to initialize Sentry:

1. Add imports at the top:
```typescript
import * as Sentry from '@sentry/react-native';
import { config, isDevelopment } from '../src/config/environment';
```

2. Initialize Sentry BEFORE the component definition (at module level, after imports):

```typescript
// Initialize Sentry (disabled in development)
if (!isDevelopment && config.sentryDsn) {
  Sentry.init({
    dsn: config.sentryDsn,
    environment: config.name,
    // Capture 100% of transactions for performance monitoring
    tracesSampleRate: 1.0,
    // Attach screenshots to error reports
    attachScreenshot: true,
    // Attach view hierarchy for debugging
    attachViewHierarchy: true,
    // Only send errors in non-dev environments
    enabled: !isDevelopment,
    // Add release info for sourcemap matching
    release: `ranz-mobile@${require('../package.json').version}`,
    // Disable in development
    debug: false,
  });
}
```

3. Wrap the root component export with Sentry:

Find the default export (likely `export default RootLayout` or similar) and wrap it:

```typescript
// If the component is already wrapped (e.g., with ClerkProvider), wrap the final export
export default Sentry.wrap(RootLayout);
```

If the current export is something like:
```typescript
export default function RootLayout() { ... }
```

Change it to:
```typescript
function RootLayout() { ... }

export default Sentry.wrap(RootLayout);
```

4. Also consider adding Sentry.captureException in the existing error boundary if one exists:

If there's an error boundary component, add:
```typescript
import * as Sentry from '@sentry/react-native';

// In the error handler:
Sentry.captureException(error);
```

This ensures the error boundary reports to Sentry in addition to showing the error UI.
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && npx tsc --noEmit app/_layout.tsx && grep "Sentry.init" app/_layout.tsx
```
  </verify>
  <done>
app/_layout.tsx imports Sentry, initializes it with environment config, and wraps the root component with Sentry.wrap. Sentry is only enabled in non-development environments.
  </done>
</task>

</tasks>

<verification>
1. @sentry/react-native installed in package.json
2. Sentry plugin configured in app.json with org and project
3. Sentry.init called in app/_layout.tsx with correct config
4. Root component wrapped with Sentry.wrap
5. Sentry disabled in development (isDevelopment check)
6. TypeScript compilation passes
</verification>

<success_criteria>
- Sentry SDK installed and configured
- Crash reports will be captured in preview and production
- Sourcemaps will be uploaded during EAS Build (via plugin)
- Development builds do not send to Sentry
- Environment name attached to reports for filtering
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-polish/15-03-SUMMARY.md`
</output>
