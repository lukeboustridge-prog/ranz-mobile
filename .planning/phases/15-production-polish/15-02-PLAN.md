---
phase: 15-production-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/environment.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Environment configuration reads EXPO_PUBLIC_APP_ENV to determine current environment"
    - "Each environment has distinct API URL and logging settings"
    - "Sentry DSN is only enabled in preview and production"
    - "Config is type-safe with TypeScript"
  artifacts:
    - path: "src/config/environment.ts"
      provides: "Environment-aware configuration"
      exports: ["config", "Environment"]
      min_lines: 30
    - path: ".env.example"
      provides: "Complete list of required environment variables"
      contains: "EXPO_PUBLIC_APP_ENV"
  key_links:
    - from: "src/config/environment.ts"
      to: "process.env.EXPO_PUBLIC_APP_ENV"
      via: "environment detection"
      pattern: "EXPO_PUBLIC_APP_ENV"
---

<objective>
Create environment-based configuration for development, preview, and production.

Purpose: Centralize environment-specific settings (API URLs, logging, Sentry DSN) to prevent configuration errors between environments. EAS Build sets EXPO_PUBLIC_APP_ENV per profile.

Output: Type-safe environment config module and updated .env.example.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-polish/15-RESEARCH.md

@.env.example
@src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment configuration module</name>
  <files>src/config/environment.ts</files>
  <action>
Create `src/config/environment.ts`:

```typescript
/**
 * Environment-based configuration for the RANZ mobile app.
 *
 * EXPO_PUBLIC_APP_ENV is set by EAS Build per profile:
 * - development: Local development with dev client
 * - preview: Internal testing builds (TestFlight, internal track)
 * - production: App store releases
 */

export type Environment = 'development' | 'preview' | 'production';

interface EnvironmentConfig {
  /** Current environment name */
  name: Environment;
  /** Base URL for API requests */
  apiUrl: string;
  /** Sentry DSN for crash reporting (empty = disabled) */
  sentryDsn: string;
  /** Enable verbose logging */
  enableLogs: boolean;
  /** Enable debug overlays and dev tools */
  enableDevTools: boolean;
  /** Clerk publishable key */
  clerkPublishableKey: string;
}

const environments: Record<Environment, Omit<EnvironmentConfig, 'name' | 'clerkPublishableKey'>> = {
  development: {
    apiUrl: process.env.EXPO_PUBLIC_API_URL || 'http://localhost:3000',
    sentryDsn: '', // Disabled in dev
    enableLogs: true,
    enableDevTools: true,
  },
  preview: {
    apiUrl: process.env.EXPO_PUBLIC_API_URL || 'https://staging.reports.ranz.org.nz',
    sentryDsn: process.env.EXPO_PUBLIC_SENTRY_DSN || '',
    enableLogs: true, // Keep logs for debugging preview builds
    enableDevTools: false,
  },
  production: {
    apiUrl: process.env.EXPO_PUBLIC_API_URL || 'https://reports.ranz.org.nz',
    sentryDsn: process.env.EXPO_PUBLIC_SENTRY_DSN || '',
    enableLogs: false, // No console logs in production
    enableDevTools: false,
  },
};

/**
 * Get the current environment from EXPO_PUBLIC_APP_ENV.
 * Defaults to 'development' if not set.
 */
function getCurrentEnvironment(): Environment {
  const env = process.env.EXPO_PUBLIC_APP_ENV;

  if (env === 'preview' || env === 'production') {
    return env;
  }

  // Default to development (includes undefined, 'development', or any invalid value)
  return 'development';
}

/**
 * Build the complete configuration for the current environment.
 */
function buildConfig(): EnvironmentConfig {
  const env = getCurrentEnvironment();
  const envConfig = environments[env];

  return {
    name: env,
    ...envConfig,
    clerkPublishableKey: process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY || '',
  };
}

/**
 * Current environment configuration.
 * Import this to access environment-specific settings.
 *
 * @example
 * import { config } from '@/config/environment';
 *
 * console.log(config.name); // 'development' | 'preview' | 'production'
 * fetch(`${config.apiUrl}/api/photos`);
 */
export const config = buildConfig();

/**
 * Helper to check if running in development.
 */
export const isDevelopment = config.name === 'development';

/**
 * Helper to check if running in production.
 */
export const isProduction = config.name === 'production';

/**
 * Log the current environment on startup (dev only).
 */
if (config.enableLogs) {
  console.log(`[Environment] Running in ${config.name} mode`);
  console.log(`[Environment] API URL: ${config.apiUrl}`);
  console.log(`[Environment] Sentry: ${config.sentryDsn ? 'enabled' : 'disabled'}`);
}
```

Create the config directory if it doesn't exist:
```bash
mkdir -p src/config
```
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && npx tsc --noEmit src/config/environment.ts
```
  </verify>
  <done>
src/config/environment.ts exports config, Environment type, isDevelopment, and isProduction helpers. Environment is detected from EXPO_PUBLIC_APP_ENV.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with all variables</name>
  <files>.env.example</files>
  <action>
Update `.env.example` to include all environment variables:

```bash
# RANZ Mobile App Environment Variables
# Copy this to .env and fill in values

# Environment (set by EAS Build, or manually for local dev)
# Values: development, preview, production
EXPO_PUBLIC_APP_ENV=development

# Clerk Authentication
# Get from: https://dashboard.clerk.com -> API Keys
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx

# API Configuration
# For local dev, use localhost or ngrok URL
# For preview/production, this is set in EAS secrets
EXPO_PUBLIC_API_URL=http://localhost:3000

# Sentry Crash Reporting (optional for local dev)
# Get from: https://sentry.io -> Project Settings -> Client Keys
EXPO_PUBLIC_SENTRY_DSN=
```

Note the naming convention: All env vars must use EXPO_PUBLIC_ prefix to be accessible in the app bundle.
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && cat .env.example | grep EXPO_PUBLIC_APP_ENV
```
  </verify>
  <done>
.env.example includes EXPO_PUBLIC_APP_ENV, EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY, EXPO_PUBLIC_API_URL, and EXPO_PUBLIC_SENTRY_DSN with documentation comments.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update api module to use config</name>
  <files>src/lib/api.ts</files>
  <action>
Update `src/lib/api.ts` to use the new environment config:

1. Add import at top:
```typescript
import { config } from '../config/environment';
```

2. Replace the existing baseURL logic. Find where baseURL is set (likely uses process.env.EXPO_PUBLIC_API_URL directly) and replace with:

```typescript
const baseURL = config.apiUrl;
```

3. If there's any conditional logging based on __DEV__, consider using config.enableLogs instead for consistency:

```typescript
if (config.enableLogs) {
  console.log('[API]', ...);
}
```

This centralizes API URL configuration and ensures it matches the environment.
  </action>
  <verify>
```bash
cd /c/Users/LukeBoustridge/Projects/RANZ/RANZ\ Roofing\ Report/ranz-mobile && npx tsc --noEmit src/lib/api.ts
```
  </verify>
  <done>
api.ts imports config from environment.ts and uses config.apiUrl for the base URL. Logging respects config.enableLogs.
  </done>
</task>

</tasks>

<verification>
1. src/config/environment.ts exists and exports config
2. Environment detection works (defaults to development)
3. .env.example includes all four EXPO_PUBLIC_ variables
4. api.ts uses config.apiUrl
5. TypeScript compilation passes for all modified files
</verification>

<success_criteria>
- Environment config reads EXPO_PUBLIC_APP_ENV correctly
- Three environments configured: development, preview, production
- API URL, Sentry DSN, logging controlled per environment
- .env.example documents all required variables
- api module uses centralized config
</success_criteria>

<output>
After completion, create `.planning/phases/15-production-polish/15-02-SUMMARY.md`
</output>
