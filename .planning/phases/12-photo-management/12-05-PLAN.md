---
phase: 12-photo-management
plan: 05
type: execute
wave: 3
depends_on: ["12-03", "12-04"]
files_modified:
  - src/components/PhotoAnnotationScreen.tsx
  - src/components/PhotoAnnotationFlow.tsx
  - src/components/index.ts
autonomous: true

must_haves:
  truths:
    - "User can access annotation from gallery full-screen viewer"
    - "Annotation flow shows photo, opens annotator, saves result"
    - "Annotated photos display annotation indicator in gallery"
    - "User can view annotated version or original in viewer"
  artifacts:
    - path: "src/components/PhotoAnnotationFlow.tsx"
      provides: "Complete annotation workflow component"
      exports: ["PhotoAnnotationFlow"]
    - path: "src/components/PhotoAnnotationScreen.tsx"
      provides: "Updated annotation screen with flow integration"
  key_links:
    - from: "src/components/PhotoAnnotationFlow.tsx"
      to: "src/services/annotation-service.ts"
      via: "saveAnnotations for persistence"
      pattern: "saveAnnotations.*photoId"
    - from: "src/components/PhotoAnnotationFlow.tsx"
      to: "src/components/PhotoAnnotator.tsx"
      via: "PhotoAnnotator for annotation UI"
      pattern: "PhotoAnnotator"
---

<objective>
Create enhanced annotation workflow integrated with gallery

Purpose: Connect the gallery viewing experience with the existing annotation tools. When a user wants to annotate from the full-screen viewer, they should enter a smooth flow that shows the photo, allows annotation, and saves the result while maintaining evidence integrity.

Output:
- PhotoAnnotationFlow component for complete annotation workflow
- Updated PhotoAnnotationScreen with improved UX
- Gallery components updated to show annotation indicators
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-photo-management/12-RESEARCH.md
@.planning/phases/12-photo-management/12-03-SUMMARY.md
@.planning/phases/12-photo-management/12-04-SUMMARY.md

Key existing code:
@src/components/PhotoAnnotator.tsx - Existing annotation tool
@src/components/PhotoAnnotationScreen.tsx - Existing annotation screen
@src/services/annotation-service.ts - Annotation persistence
@src/hooks/usePhotoAnnotations.ts - Annotation state hook
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhotoAnnotationFlow component</name>
  <files>src/components/PhotoAnnotationFlow.tsx</files>
  <action>
Create PhotoAnnotationFlow.tsx as a complete annotation workflow container:

1. Props interface:
   ```typescript
   interface PhotoAnnotationFlowProps {
     photo: LocalPhoto;
     visible: boolean;
     onClose: () => void;
     onAnnotationSaved?: (photo: LocalPhoto, annotatedUri: string) => void;
   }
   ```

2. Workflow states:
   ```typescript
   type FlowState = 'viewing' | 'annotating' | 'saving' | 'saved';
   ```

3. Component flow:
   a. 'viewing' state:
      - Show photo full-screen
      - "Start Annotating" button
      - "Cancel" button
      - If photo has existing annotations, show "Edit Annotations" vs "Add Annotations"

   b. 'annotating' state:
      - Render PhotoAnnotator component
      - Pass existing annotations if present
      - Handle onSave and onCancel callbacks

   c. 'saving' state:
      - Show loading indicator
      - Call annotation-service.saveAnnotations
      - Handle success/error

   d. 'saved' state:
      - Brief success message
      - Auto-close after 1.5 seconds
      - Call onAnnotationSaved callback

4. Error handling:
   - Show error alert if save fails
   - Return to 'viewing' state on error
   - Allow retry

5. Evidence integrity:
   - Display reminder that original is preserved
   - Show annotation count badge

6. Use Modal for the entire flow.

7. Import and use:
   - PhotoAnnotator from existing component
   - saveAnnotations from annotation-service
   - loadAnnotations for existing annotations
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Component file exists with PhotoAnnotationFlow export.
Verify annotation-service imports are present.
  </verify>
  <done>PhotoAnnotationFlow component created with complete annotation workflow</done>
</task>

<task type="auto">
  <name>Task 2: Update PhotoAnnotationScreen for improved flow</name>
  <files>src/components/PhotoAnnotationScreen.tsx</files>
  <action>
Update the existing PhotoAnnotationScreen.tsx to integrate better with the gallery:

1. Add props for gallery integration:
   ```typescript
   interface PhotoAnnotationScreenProps {
     photo: LocalPhoto;
     onClose: () => void;
     onAnnotationSaved?: (annotatedUri: string) => void;
     // Existing props...
   }
   ```

2. Update the save handler to:
   - Call onAnnotationSaved callback after successful save
   - Show success feedback

3. Add annotation count display in header:
   - "X annotations" badge showing current count

4. Add "View Original" button:
   - Allows viewing the original photo without annotations
   - Helps inspector compare annotated vs original

5. Improve loading states:
   - Show loading indicator during save
   - Disable save button while saving

6. Add confirmation on discard:
   - If user has unsaved changes and presses cancel
   - Show "Discard changes?" confirmation alert

IMPORTANT: Preserve all existing functionality. This is an enhancement, not a rewrite.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Existing exports still work.
New callback props are added.
  </verify>
  <done>PhotoAnnotationScreen updated with improved flow and gallery integration</done>
</task>

<task type="auto">
  <name>Task 3: Export PhotoAnnotationFlow and update index</name>
  <files>src/components/index.ts</files>
  <action>
Add export for PhotoAnnotationFlow to components/index.ts:

```typescript
export { PhotoAnnotationFlow } from "./PhotoAnnotationFlow";
```

Verify PhotoAnnotationScreen export still exists (should already be there).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Verify components/index.ts includes PhotoAnnotationFlow export.
  </verify>
  <done>PhotoAnnotationFlow exported from components/index.ts</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. PhotoAnnotationFlow.tsx exists with correct exports
3. PhotoAnnotationScreen.tsx updated with new props
4. components/index.ts exports PhotoAnnotationFlow
5. Verify annotation-service integration in flow component
</verification>

<success_criteria>
- PhotoAnnotationFlow provides complete annotation workflow
- Flow states (viewing, annotating, saving, saved) work correctly
- Existing annotations are loaded and editable
- New annotations save correctly via annotation-service
- PhotoAnnotationScreen has improved UX with loading states
- Evidence integrity maintained (original never modified)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-photo-management/12-05-SUMMARY.md`
</output>
