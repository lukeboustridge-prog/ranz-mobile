---
phase: 12-photo-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/thumbnail-service.ts
  - src/services/photo-service.ts
  - src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Thumbnails are generated at 200px width, 70% JPEG quality"
    - "Thumbnail generation happens during photo capture flow"
    - "Existing photos can have thumbnails regenerated"
    - "Dependencies expo-image-manipulator and @likashefqet/react-native-image-zoom are installed"
  artifacts:
    - path: "src/services/thumbnail-service.ts"
      provides: "Thumbnail generation and management"
      exports: ["generateThumbnail", "deleteThumbnail", "regenerateThumbnails"]
    - path: "package.json"
      provides: "New dependencies for image manipulation and zoom"
      contains: "expo-image-manipulator"
  key_links:
    - from: "src/services/photo-service.ts"
      to: "src/services/thumbnail-service.ts"
      via: "generateThumbnail call in capturePhoto"
      pattern: "generateThumbnail.*photoId"
---

<objective>
Create thumbnail service for efficient photo grid display

Purpose: Photo grids need thumbnails for performance - loading full-resolution images causes memory pressure and slow scrolling. This plan establishes the thumbnail generation infrastructure that integrates with existing photo capture.

Output:
- Thumbnail service with generation, deletion, and batch regeneration
- Dependencies installed for image manipulation and zoom viewer
- Photo capture flow updated to generate thumbnails on capture
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-photo-management/12-RESEARCH.md

Key existing code:
@src/lib/file-storage.ts - STORAGE_PATHS.thumbnails path
@src/services/photo-service.ts - Photo capture flow to integrate with
@src/types/database.ts - LocalPhoto.thumbnailUri field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install image manipulation dependencies</name>
  <files>package.json</files>
  <action>
Install expo-image-manipulator and @likashefqet/react-native-image-zoom using npx expo install.

These packages are required for:
- expo-image-manipulator: Resize images for thumbnail generation (native performance, handles EXIF rotation)
- @likashefqet/react-native-image-zoom: Pinch-to-zoom full-screen viewer (used in Plan 03)

Command: `npx expo install expo-image-manipulator @likashefqet/react-native-image-zoom`

Verify both packages appear in package.json dependencies after installation.
  </action>
  <verify>
Run `npm ls expo-image-manipulator @likashefqet/react-native-image-zoom` to confirm both packages are installed.
Both should show version numbers without UNMET PEER DEPENDENCY errors.
  </verify>
  <done>expo-image-manipulator and @likashefqet/react-native-image-zoom installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create thumbnail service</name>
  <files>src/services/thumbnail-service.ts</files>
  <action>
Create thumbnail-service.ts with the following exports:

1. `generateThumbnail(sourceUri: string, photoId: string): Promise<string>`
   - Resize to 200px width, maintain aspect ratio
   - Compress to 70% JPEG quality
   - Save to STORAGE_PATHS.thumbnails as `thumb_{photoId}.jpg`
   - Return the thumbnail path
   - If thumbnail already exists, return existing path (idempotent)
   - On error, log and return sourceUri as fallback (graceful degradation)

2. `deleteThumbnail(photoId: string): Promise<void>`
   - Delete thumbnail file if exists
   - Use idempotent: true to avoid errors on missing files

3. `regenerateThumbnails(photos: LocalPhoto[]): Promise<{ success: number; failed: number }>`
   - Batch regenerate thumbnails for multiple photos
   - Return counts of successful and failed regenerations
   - Useful for migration or if thumbnails are corrupted

4. `getThumbnailPath(photoId: string): string`
   - Return the path where thumbnail should be stored
   - Does not check if file exists

Implementation pattern from research:
```typescript
import { manipulateAsync, SaveFormat } from 'expo-image-manipulator';
import { getInfoAsync, moveAsync, deleteAsync } from 'expo-file-system/legacy';
import { STORAGE_PATHS } from '../lib/file-storage';

const THUMBNAIL_WIDTH = 200;
const THUMBNAIL_QUALITY = 0.7;
```

Include JSDoc comments for all public functions.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
Check that file exists and exports all four functions.
  </verify>
  <done>thumbnail-service.ts created with generateThumbnail, deleteThumbnail, regenerateThumbnails, getThumbnailPath exports</done>
</task>

<task type="auto">
  <name>Task 3: Integrate thumbnail generation into photo capture</name>
  <files>src/services/photo-service.ts, src/services/index.ts</files>
  <action>
Update photo-service.ts to generate thumbnails during capture:

1. Import generateThumbnail from thumbnail-service:
   ```typescript
   import { generateThumbnail } from "./thumbnail-service";
   ```

2. In the capturePhoto function, after storing the working copy and before returning:
   - Call generateThumbnail with the working copy URI and photo ID
   - Store the returned thumbnail path in the LocalPhoto.thumbnailUri field
   - Wrap in try/catch - thumbnail generation failure should NOT fail photo capture

3. Update the LocalPhoto object construction to include thumbnailUri:
   ```typescript
   thumbnailUri: thumbnailPath, // From generateThumbnail result
   ```

4. In the deletePhoto function (if it exists), also call deleteThumbnail.

5. Add thumbnail-service export to src/services/index.ts:
   ```typescript
   export * from "./thumbnail-service";
   ```

CRITICAL: Thumbnail generation must be non-blocking for photo capture. If it fails, log the error and continue with thumbnailUri set to null.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Verify photo-service.ts imports generateThumbnail and uses it in capturePhoto.
Verify thumbnail-service is exported from services/index.ts.
  </verify>
  <done>Photo capture flow generates thumbnails, thumbnailUri populated in LocalPhoto, thumbnail deleted with photo</done>
</task>

</tasks>

<verification>
1. Both new packages installed: `npm ls expo-image-manipulator @likashefqet/react-native-image-zoom`
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. thumbnail-service.ts exists with all exported functions
4. photo-service.ts imports and uses generateThumbnail
5. services/index.ts exports thumbnail-service
</verification>

<success_criteria>
- Dependencies installed and package.json updated
- Thumbnail service created with 4 exported functions
- Photo capture flow integrated with thumbnail generation
- Graceful degradation - thumbnail failure does not block photo capture
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-photo-management/12-01-SUMMARY.md`
</output>
